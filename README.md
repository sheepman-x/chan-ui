# 📈 缠论图表可视化系统

基于 chan.py + Streamlit + Plotly 实现的专业缠论技术分析工具

## ✨ 功能特色

- 🔄 **完整缠论指标支持**：笔、线段、中枢、买卖点的精确计算和可视化
- 📊 **专业图表展示**：基于 Plotly 的交互式高质量图表
- ⚙️ **灵活参数配置**：支持严格笔、中枢合并等多种缠论参数调整
- 🎯 **精确数据映射**：通过完整单元测试验证的数据转换逻辑
- 🎨 **简洁用户界面**：专注核心功能，去除多余控件和干扰项
- 📈 **实时数据支持**：集成 BaoStock 数据源，支持A股实时数据

## 🏗️ 项目架构

```
chan-ui/
├── chan.py/                    # chan.py框架（子模块）
├── chan_viz/                   # 可视化核心模块
│   ├── config_compiler.py      # 配置编译器
│   ├── data_service.py         # 数据服务层
│   └── chart_render.py         # 图表渲染器
├── tests/                      # 单元测试
│   └── test_data_conversion.py # 数据转换验证
├── run_app.py                  # 主应用入口
└── dev_plan.md                 # 开发计划
```

## 🚀 快速开始

### 1. 环境配置
```bash
# 创建虚拟环境
python -m venv chan-viz-env
source chan-viz-env/bin/activate

# 安装依赖
pip install streamlit plotly pandas baostock matplotlib ipython
```

### 2. 启动应用
```bash
streamlit run run_app.py
# 浏览器自动打开 http://localhost:8501
```

### 3. 使用验证
1. 浏览器打开 `http://localhost:8501`
2. 输入股票代码：`000002`
3. 选择时间级别：`K_DAY`（日线）
4. 设置时间范围：建议1年以内
5. 点击"🚀 生成/更新图表"按钮
6. 即可看到包含K线+笔+线段+中枢+买卖点的完整缠论图表

## 🧪 质量保证

### 单元测试验证
项目包含完整的单元测试套件，确保数据转换逻辑的准确性：

```bash
# 运行测试
python tests/test_data_conversion.py
```

**测试覆盖**：
- ✅ K线数据转换：日期、OHLC、成交量
- ✅ 笔数据转换：起止坐标、价格、方向逻辑
- ✅ 线段数据转换：坐标映射、价格计算
- ✅ 中枢数据转换：范围坐标、价格区间
- ✅ 买卖点数据转换：索引映射、价格定位
- ✅ 数据逻辑一致性：方向交替、索引连续性

**测试结果示例**：
```
🧪 缠论数据转换单元测试
✓ 成功加载K线数据，共 190 个合并K线
✓ 笔数量: 11 | 线段数量: 2 | 中枢数量: 1 | 买卖点数量: 1
✅ 成功率: 100.0%
```

## 📊 技术实现

### 核心组件

1. **配置编译器** (`config_compiler.py`)
   - 将 Streamlit UI 参数转换为 chan.py 配置
   - 支持多种时间级别和缠论参数

2. **数据服务层** (`data_service.py`)
   - 集成 chan.py 框架获取缠论计算结果
   - 实现数据格式转换和坐标映射
   - 提供缓存机制提升性能

3. **图表渲染器** (`chart_render.py`)
   - 基于 Plotly 实现专业图表渲染
   - 支持 K线、笔、线段、中枢、买卖点可视化
   - 优化图例显示和交互体验

### 数据转换流程

```
chan.py原始数据 → 数据提取 → 坐标映射 → Plotly格式 → 图表渲染
     ↓              ↓          ↓           ↓          ↓
  CChan对象     笔/线段/中枢   索引→日期    JSON数据    交互图表
```

## 🎯 使用指南

### 股票代码格式
- **深交所**：`000001`（系统自动转换为`000001.SZ`）
- **上交所**：`600000`（系统自动转换为`600000.SH`）

### 时间级别选择
- `K_DAY`：日线（推荐）
- `K_60M`：60分钟线
- `K_30M`：30分钟线
- `K_15M`：15分钟线
- `K_5M`：5分钟线
- `K_1M`：1分钟线

### 缠论参数配置
- **严格笔**：使用严格的笔定义（推荐开启）
- **中枢合并**：合并相邻中枢（推荐开启）
- **显示选项**：可选择显示笔、线段、中枢、买卖点

## 📈 图表说明

### 图例说明
- 🕯️ **K线**：红涨绿跌的标准A股蜡烛图
- 📍 **笔**：红色细线，识别趋势的最小单位
- 📏 **线段**：青色粗线，由笔组成的更大级别趋势
- 🏛️ **中枢**：蓝色半透明矩形，价格震荡区间
- 🔺 **买点**：绿色向上三角，买入信号点
- 🔻 **卖点**：红色向下三角，卖出信号点

### 买卖点类型说明
缠论系统识别多种买卖点类型，图表中通过文字标签显示：

- **b1 / s1** - 一类买卖点：趋势转折点，最重要的买卖信号
  - *特征*：大号三角形标记
  - *含义*：趋势的起始或结束点

- **b2 / s2** - 二类买卖点：趋势延续中的回调点  
  - *特征*：标准大小三角形标记
  - *含义*：趋势中的次级回调，提供加仓或减仓机会

- **b3 / s3** - 三类买卖点：趋势末端的确认点
  - *特征*：小号三角形标记
  - *含义*：趋势末端的确认信号，风险较高

- **复合类型**：如 b2,3b / s2,3b
  - *含义*：同时满足多个买卖点条件
  - *示例*：b2,3b 表示既是二类买点又是三类b买点

### 交互功能
- **鼠标悬停**：查看详细价格和时间信息
- **图例控制**：点击图例项可显示/隐藏对应元素
- **响应式设计**：自适应不同屏幕尺寸

## 🔧 开发计划

### 已完成功能 ✅
- [x] 基础 Streamlit 应用框架
- [x] chan.py 框架集成
- [x] K线数据可视化
- [x] 缠论指标计算和展示（笔、线段、中枢、买卖点）
- [x] 专业图表渲染和优化
- [x] 完整单元测试覆盖
- [x] 数据转换逻辑验证
- [x] 用户界面优化

### 规划中功能 🚧
- [ ] 支持港股、美股数据（当前仅支持A股）
- [ ] 增加更多技术指标（MACD、均线等）
- [ ] 历史回测功能
- [ ] 数据导出功能
- [ ] 移动端适配

## 🤝 贡献指南

1. Fork 本项目
2. 创建功能分支：`git checkout -b feature/amazing-feature`
3. 提交更改：`git commit -m 'Add some amazing feature'`
4. 推送分支：`git push origin feature/amazing-feature`
5. 创建 Pull Request

## 📝 更新日志

### v2.3 (2024-08-24) - 显示精度优化
- 🎯 **修复买卖点价格显示**：使用笔的结束价格而非K线收盘价，确保hover显示chan.py返回的准确价格
- 📏 **笔/线段/中枢显示优化**：根据`is_sure`字段动态显示实线/虚线，确定的用实线，不确定的用虚线
- 🧹 **界面简洁化**：移除底部信息显示（支持级别、参数选项、元素类型、缓存时间）和清空缓存按钮
- 📊 **增强hover信息**：显示笔、线段、中枢的确定状态信息

### v2.2 (2024-08-24) - 买卖点显示优化
- 🎯 **修复123买卖点显示**：严格复制chan.py样式，正确显示各类买卖点类型
- 📝 **增强文字标签**：黑色大字体显示买卖点类型（b1, s2, b2,3b等）
- 📊 **优化位置布局**：买点向下偏移，卖点向上偏移，远离K线清晰显示
- 🏷️ **完善图例说明**：添加买卖点类型图例和详细使用说明

### v2.1 (2024-08-24) - 缠论指标精度优化
- 🎯 **修复笔连接点问题**：采用官方chan.py Plot方法确保笔与笔完美连接
- 📐 **精确坐标映射**：使用`get_begin_klu()`、`get_end_klu()`等官方方法获取精确坐标
- 🔧 **索引映射重构**：建立K线单元全局索引映射系统，解决指标位置偏移
- 🧪 **测试完善**：更新单元测试适配新的数据提取方法，保持100%通过率

### v2.0 (2024-08-24)
- ✨ 完成专业级缠论图表可视化系统
- 🔧 优化图表显示，去除多余控件
- 🧪 新增完整单元测试验证数据转换逻辑
- 🎨 优化图例显示和用户体验
- 📊 修复缠论指标与K线的精确对应关系

### v1.0 (2024-08-23)
- 🚀 初始版本发布
- 📈 基础 Streamlit + Plotly 图表系统
- 🔗 chan.py 框架集成
- 📊 基础缠论指标可视化

## 📄 许可证

本项目基于 MIT 许可证开源 - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- [chan.py](https://github.com/Vespa314/chan.py) - 提供强大的缠论计算框架
- [Streamlit](https://streamlit.io/) - 快速构建数据应用
- [Plotly](https://plotly.com/) - 专业的交互式图表库
- [BaoStock](http://baostock.com/) - 免费的股票数据接口